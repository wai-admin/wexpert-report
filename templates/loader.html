<!--
  WARNING: CI 파일에서 loader.html을 사용하고 있기 때문에 수정 시 주의해야함.
-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Expires" content="0" />
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: rgba(39, 41, 44, 1);
        width: 100vw;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <script>
      // 버전별 경로로 리다이렉트
      function loadApp(nativeVersion) {
        // 웹에서는 targetUrl로 이동하여 index.html을 찾지만, WebView2에서는 index.html을 찾지 못하므로 index.html을 직접 열어준다.
        const targetUrl = "/versions/" + nativeVersion + "/index.html";
        window.location.href = targetUrl;
      }

      // S3에 배포된 사용 가능한 버전 목록 (CI/CD에서 주입)
      const MINIMUM_APP_VERSION = "__MINIMUM_APP_VERSION__";
      const CURRENT_APP_VERSION = "__CURRENT_APP_VERSION__";
      const SUPPORTED_APP_VERSIONS = __SUPPORTED_APP_VERSIONS__;

      // 버전 문자열을 숫자로 변환 ("1.8.1.00000" → 18100000)
      function versionToNumber(version) {
        return parseInt(version.replace(/\./g, ""), 10);
      }

      // 버전 비교 함수
      function compareVersions(v1, v2) {
        return versionToNumber(v1) - versionToNumber(v2);
      }

      // 버전 매칭 로직 (3가지 시나리오)
      function findClosestVersion(targetVersion) {
        // S3에 배포된 버전이 없으면 기본 버전 반환
        if (SUPPORTED_APP_VERSIONS.length === 0) {
          return "__MINIMUM_APP_VERSION__";
        }

        const targetAppVersionNum = versionToNumber(targetVersion);
        const minimumAppVersionNum = versionToNumber(MINIMUM_APP_VERSION);
        const currentAppVersionNum = versionToNumber(CURRENT_APP_VERSION);

        // 시나리오 1: minimumAppVersion <= nativeVersion <= currentAppVersion
        if (
          targetAppVersionNum >= minimumAppVersionNum &&
          targetAppVersionNum <= currentAppVersionNum
        ) {
          return MINIMUM_APP_VERSION;
        }

        // 시나리오 2: nativeVersion > currentAppVersion (미래 버전)
        if (targetAppVersionNum > currentAppVersionNum) {
          return MINIMUM_APP_VERSION;
        }

        // 시나리오 3: nativeVersion < minimumAppVersion (과거 버전)

        // supportedVersions에서 가장 가까우면서 낮은 버전 찾기
        let closestVersion = null;
        let minDiff = Infinity;

        for (let i = 0; i < SUPPORTED_APP_VERSIONS.length; i++) {
          const version = SUPPORTED_APP_VERSIONS[i];
          const versionNum = versionToNumber(version);

          // targetVersion보다 낮거나 같은 버전만 고려
          if (versionNum <= targetAppVersionNum) {
            const diff = targetAppVersionNum - versionNum;

            if (diff < minDiff) {
              minDiff = diff;
              closestVersion = version;
            }
          }
        }

        if (closestVersion) {
          return closestVersion;
        }

        // 모든 버전이 targetVersion보다 높으면 가장 낮은 버전 사용
        const lowestVersion = SUPPORTED_APP_VERSIONS.reduce((lowest, current) =>
          compareVersions(current, lowest) < 0 ? current : lowest
        );

        return lowestVersion;
      }

      // C# WebView2 Bridge 통신
      function initializeBridge() {
        if (window.chrome?.webview) {
          window.chrome.webview.addEventListener("message", function (event) {
            const data = event.data?.data || event.data;

            if (data.nativeVersion) {
              const matchedVersion = findClosestVersion(data.nativeVersion);
              loadApp(matchedVersion);
            }
          });

          // C#에 초기화 메시지 전송
          window.chrome.webview.postMessage({
            type: "initialized",
          });
        } else {
          // 개발 환경 fallback
          loadApp("__MINIMUM_APP_VERSION__");
        }
      }

      // DOM 로드 후 실행
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializeBridge);
      } else {
        initializeBridge();
      }
    </script>
  </body>
</html>
