<!--
  WARNING: CI 파일에서 loader.html을 사용하고 있기 때문에 수정 시 주의해야함.
-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Expires" content="0" />
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: rgba(39, 41, 44, 1);
        width: 100vw;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <script>
      // 버전별 경로로 리다이렉트
      function loadApp(nativeVersion) {
        // 웹에서는 targetUrl로 이동하여 index.html을 찾지만, WebView2에서는 index.html을 찾지 못하므로 index.html을 직접 열어준다.
        const targetUrl = "/versions/" + nativeVersion + "/index.html";
        window.location.href = targetUrl;
      }

      // S3에 배포된 사용 가능한 버전 목록 (CI/CD에서 주입)
      const AVAILABLE_VERSIONS = __AVAILABLE_VERSIONS__;

      // 버전 문자열을 숫자로 변환 ("1.8.1.00000" → 18100000)
      function versionToNumber(version) {
        return parseInt(version.replace(/\./g, ""), 10);
      }

      // 가장 가까운 버전 찾기
      function findClosestVersion(targetVersion) {
        // S3에 배포된 버전이 없으면 기본 버전 반환
        if (AVAILABLE_VERSIONS.length === 0) {
          return "__APP_VERSION__";
        }

        // 정확히 일치하는 버전이 있으면 바로 반환
        if (AVAILABLE_VERSIONS.includes(targetVersion)) {
          return targetVersion;
        }

        // 일치하는 버전이 없으면 가장 가까운 버전 찾기
        const targetNum = versionToNumber(targetVersion);
        let closestVersion = AVAILABLE_VERSIONS[0];
        let minDiff = Math.abs(versionToNumber(closestVersion) - targetNum);

        for (let i = 1; i < AVAILABLE_VERSIONS.length; i++) {
          const version = AVAILABLE_VERSIONS[i];
          const diff = Math.abs(versionToNumber(version) - targetNum);

          if (diff < minDiff) {
            minDiff = diff;
            closestVersion = version;
          }
        }

        return closestVersion;
      }

      // C# WebView2 Bridge 통신
      function initializeBridge() {
        if (window.chrome?.webview) {
          window.chrome.webview.addEventListener("message", function (event) {
            const data = event.data?.data || event.data;

            if (data.nativeVersion) {
              const matchedVersion = findClosestVersion(data.nativeVersion);
              loadApp(matchedVersion);
            }
          });

          // C#에 초기화 메시지 전송
          window.chrome.webview.postMessage({
            type: "initialized",
          });
        } else {
          // 개발 환경 fallback
          loadApp("__APP_VERSION__");
        }
      }

      // DOM 로드 후 실행
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializeBridge);
      } else {
        initializeBridge();
      }
    </script>
  </body>
</html>
