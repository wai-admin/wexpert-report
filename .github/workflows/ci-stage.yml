name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    env: # ëª¨ë“  stepì—ì„œ ê³µìœ ë˜ëŠ” í™˜ê²½ë³€ìˆ˜
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}

    steps:
      - name: ğŸ“· Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦¿ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22.13.1

      - name: ğŸ”§ Install pnpm
        run: npm i -g pnpm

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ§¹ Lint
        run: pnpm lint

      - name: ğŸŒ Build
        run: pnpm build

      # version ì¶”ì¶œ (config/versions.jsonì˜ minimumAppVersion ì‚¬ìš©)
      - name: ğŸ· Extract version
        id: version
        run: |
          MINIMUM_APP=$(cat config/versions.json | jq -r '.minimumAppVersion')
          echo "MINIMUM_APP_VERSION=$MINIMUM_APP" >> $GITHUB_ENV

      # dist êµ¬ì¡° ì¬ì •ë ¬
      - name: ğŸ—‚ Prepare versioned build
        run: |
          mkdir -p output/versions/${{ env.MINIMUM_APP_VERSION }}
          cp -r dist/* output/versions/${{ env.MINIMUM_APP_VERSION }}/

      # loader index.html ìƒì„±
      - name: ğŸ§© Generate loader index.html
        env:
          S3_BUCKET: wexpert-report-stg
        run: |
          # í…œí”Œë¦¿ íŒŒì¼ ë³µì‚¬
          cp templates/loader.html output/index.html

          # config/versions.jsonì—ì„œ ë²„ì „ ì •ë³´ ì¶”ì¶œ
          MINIMUM_APP_VERSION=$(cat config/versions.json | jq -r '.minimumAppVersion')
          CURRENT_APP_VERSION=$(cat config/versions.json | jq -r '.currentAppVersion')
          SUPPORTED_APP_VERSIONS=$(cat config/versions.json | jq -c '.supportedAppVersions')

          # ë³€ìˆ˜ ì¹˜í™˜
          sed -i "s/__MINIMUM_APP_VERSION__/$MINIMUM_APP_VERSION/g" output/index.html
          sed -i "s/__CURRENT_APP_VERSION__/$CURRENT_APP_VERSION/g" output/index.html
          sed -i "s/__SUPPORTED_APP_VERSIONS__/$SUPPORTED_APP_VERSIONS/g" output/index.html

      # ë””ë²„ê¹…: output í´ë” êµ¬ì¡° í™•ì¸
      - name: ğŸ” Check output structure
        run: |
          ls -R output/

      - name: ğŸ“¤ Deploy to S3
        env:
          S3_BUCKET: wexpert-report-stg
        run: |
          # ìƒˆ êµ¬ì¡° ì—…ë¡œë“œ (ì´ì „ ë²„ì „ ë³´ì¡´)
          aws s3 sync ./output/ s3://$S3_BUCKET/ --exclude ".DS_Store"

      - name: ğŸ” Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_STG }} \
            --paths "/*"
