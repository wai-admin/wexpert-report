name: CI

on:
  push:
    branches: [prod]
  pull_request:
    branches: [prod]

jobs:
  build:
    runs-on: ubuntu-latest
    env: # ëª¨ë“  stepì—ì„œ ê³µìœ ë˜ëŠ” í™˜ê²½ë³€ìˆ˜
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}

    steps:
      - name: ğŸ“· Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦¿ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22.13.1

      - name: ğŸ”§ Install pnpm
        run: npm i -g pnpm

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ§¹ Lint
        run: pnpm lint

      - name: ğŸŒ Build
        run: pnpm build

      # version ì¶”ì¶œ (config/versions.jsonì˜ latestVersion ì‚¬ìš©)
      - name: ğŸ· Extract version
        id: version
        run: |
          LATEST=$(cat config/versions.json | jq -r '.latestVersion')
          echo "LATEST_VERSION=$LATEST" >> $GITHUB_ENV
          echo "Extracted latestVersion from config: $LATEST"

      # dist êµ¬ì¡° ì¬ì •ë ¬
      - name: ğŸ—‚ Prepare versioned build
        run: |
          mkdir -p output/versions/${{ env.LATEST_VERSION }}
          cp -r dist/* output/versions/${{ env.LATEST_VERSION }}/

      # loader index.html ìƒì„±
      - name: ğŸ§© Generate loader index.html
        env:
          S3_BUCKET: wexpert-report
        run: |
          # í…œí”Œë¦¿ íŒŒì¼ ë³µì‚¬
          cp templates/loader.html output/index.html

          # config/versions.jsonì—ì„œ ë²„ì „ ì •ë³´ ì¶”ì¶œ
          LATEST_VERSION=$(cat config/versions.json | jq -r '.latestVersion')
          LAST_VERSION=$(cat config/versions.json | jq -r '.lastVersion')
          SUPPORTED_VERSIONS=$(cat config/versions.json | jq -c '.supportedVersions')

          # latestVersionì„ supportedVersionsì— ì¶”ê°€ (ì¤‘ë³µ ì²´í¬)
          if [[ "$SUPPORTED_VERSIONS" != *"\"$LATEST_VERSION\""* ]]; then
            if [ "$SUPPORTED_VERSIONS" = "[]" ]; then
              AVAILABLE_VERSIONS="[\"$LATEST_VERSION\"]"
            else
              # ë°°ì—´ ëì— ì¶”ê°€: ["1.8.1"] â†’ ["1.8.1","1.9.0"]
              AVAILABLE_VERSIONS="${SUPPORTED_VERSIONS%]*},\"$LATEST_VERSION\"]"
            fi
          else
            AVAILABLE_VERSIONS="$SUPPORTED_VERSIONS"
          fi

          echo "ğŸ“¦ Latest Version: $LATEST_VERSION"
          echo "ğŸ“¦ Last Version: $LAST_VERSION"
          echo "ğŸ“¦ Supported Versions: $SUPPORTED_VERSIONS"
          echo "ğŸ“¦ Available Versions (for loader): $AVAILABLE_VERSIONS"

          # ë³€ìˆ˜ ì¹˜í™˜
          sed -i "s/__LATEST_VERSION__/$LATEST_VERSION/g" output/index.html
          sed -i "s/__LAST_VERSION__/$LAST_VERSION/g" output/index.html
          sed -i "s/__AVAILABLE_VERSIONS__/$AVAILABLE_VERSIONS/g" output/index.html

      # ë””ë²„ê¹…: output í´ë” êµ¬ì¡° í™•ì¸
      - name: ğŸ” Check output structure
        run: |
          ls -R output/

      - name: ğŸ“¤ Deploy to S3
        env:
          S3_BUCKET: wexpert-report
        run: |
          echo "ğŸ“¤ Uploading new version..."

          # ìƒˆ êµ¬ì¡° ì—…ë¡œë“œ (ì´ì „ ë²„ì „ ë³´ì¡´)
          aws s3 sync ./output/ s3://$S3_BUCKET/ --exclude ".DS_Store"

          echo "âœ… Deployed to s3://$S3_BUCKET/"
          echo "ğŸ“¦ Version: ${{ env.LATEST_VERSION }}"

      - name: ğŸ” Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_PROD }} \
            --paths "/*"
