name: CI

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]

jobs:
  build:
    runs-on: ubuntu-latest
    env: # ëª¨ë“  stepì—ì„œ ê³µìœ ë˜ëŠ” í™˜ê²½ë³€ìˆ˜
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}

    steps:
      - name: ğŸ“· Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦¿ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22.13.1

      - name: ğŸ”§ Install pnpm
        run: npm i -g pnpm

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ§¹ Lint
        run: pnpm lint

      - name: ğŸŒ Build
        run: pnpm build

      # version ì¶”ì¶œ
      - name: ğŸ· Extract version
        id: version
        run: echo "APP_VERSION=$(cat package.json | jq -r .version)" >> $GITHUB_ENV

      # dist êµ¬ì¡° ì¬ì •ë ¬
      - name: ğŸ—‚ Prepare versioned build
        run: |
          mkdir -p output/versions/v${{ env.APP_VERSION }}
          cp -r dist/* output/versions/v${{ env.APP_VERSION }}/

      # loader index.html ìƒì„±
      - name: ğŸ§© Generate loader index.html
        run: |
          cat << 'EOF' > output/index.html
          <!doctype html>
          <html lang="en">
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
              <meta http-equiv="Expires" content="0" />
              <title>W Expert Report - Loading...</title>
              <style>
                body {
                  margin: 0;
                  padding: 0;
                  overflow: hidden;
                }
                #loading {
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  height: 100vh;
                  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                  color: #666;
                }
              </style>
            </head>
            <body>
              <script>
                function loadApp(nativeVersion) {
                  console.log('[Loader] Loading version:', nativeVersion);
                  
                  const url = '/versions/v' + nativeVersion + '/index.html';
                  const iframe = document.createElement('iframe');
                  iframe.src = url;
                  iframe.style.width = '100vw';
                  iframe.style.height = '100vh';
                  iframe.style.border = '0';
                  iframe.style.position = 'absolute';
                  iframe.style.top = '0';
                  iframe.style.left = '0';

                  document.body.appendChild(iframe);
                }

                // C# WebView2 Bridge í†µì‹ 
                function initializeBridge() {
                  if (window.chrome?.webview) {
                    console.log('[Loader] WebView2 bridge detected');
                    window.chrome.webview.addEventListener('message', function(event) {
                      console.log('[Loader] Received message from C#:', event.data);
                      const data = event.data?.data || event.data;
                      
                      if (data.nativeVersion) {
                        loadApp(data.nativeVersion);
                      }
                    });

                    // C#ì— ì´ˆê¸°í™” ë©”ì‹œì§€ ì „ì†¡
                    window.chrome.webview.postMessage({ 
                      type: 'initialized',
                      from: 'loader' 
                    });
                    console.log('[Loader] Sent initialization message to C#');
                  } else {
                    console.log('[Loader] No WebView2 bridge detected, using fallback version');
                    // ê°œë°œ í™˜ê²½ fallback
                    console.warn('[Loader] No WebView2 bridge detected, using fallback version');
                    loadApp('${{ env.APP_VERSION }}');
                  }
                }

                // DOM ë¡œë“œ í›„ ì‹¤í–‰
                if (document.readyState === 'loading') {
                  document.addEventListener('DOMContentLoaded', initializeBridge);
                } else {
                  initializeBridge();
                }
              </script>
            </body>
          </html>
          EOF

      # ë””ë²„ê¹…: output í´ë” êµ¬ì¡° í™•ì¸
      - name: ğŸ” Check output structure
        run: |
          ls -R output/

      - name: ğŸ“¤ Deploy to S3
        env:
          S3_BUCKET: wexpert-report-dev
        run: |
          echo "ğŸ§¹ Cleaning up root-level legacy files..."
          # ë£¨íŠ¸ ë ˆë²¨ì˜ ì˜¤ë˜ëœ íŒŒì¼ ì •ë¦¬ (index.html ì œì™¸)
          aws s3 rm s3://$S3_BUCKET/assets/ --recursive 2>/dev/null || echo "No assets/ to clean"
          aws s3 rm s3://$S3_BUCKET/images/ --recursive 2>/dev/null || echo "No images/ to clean"
          aws s3 rm s3://$S3_BUCKET/service-worker.js 2>/dev/null || echo "No service-worker.js to clean"

          echo ""
          echo "ğŸ“¤ Uploading new version..."
          # ìƒˆ êµ¬ì¡° ì—…ë¡œë“œ (ì´ì „ ë²„ì „ ë³´ì¡´)
          aws s3 sync ./output/ s3://$S3_BUCKET/ --exclude ".DS_Store"

          echo "âœ… Deployed to s3://$S3_BUCKET/"
          echo "ğŸ“¦ Version: v${{ env.APP_VERSION }}"

      - name: ğŸ” Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_DEV }} \
            --paths "/*"
