name: CI

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]

jobs:
  build:
    runs-on: ubuntu-latest
    env: # ëª¨ë“  stepì—ì„œ ê³µìœ ë˜ëŠ” í™˜ê²½ë³€ìˆ˜
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}

    steps:
      - name: ğŸ“· Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦¿ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22.13.1

      - name: ğŸ”§ Install pnpm
        run: npm i -g pnpm

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ§¹ Lint
        run: pnpm lint

      - name: ğŸŒ Build
        run: pnpm build

      # version ì¶”ì¶œ (ì „ì²´ ë²„ì „ ì‚¬ìš© â†’ ë©”ì´ì €.ë§ˆì´ë„ˆ.íŒ¨ì¹˜.ë¹Œë“œ)
      - name: ğŸ· Extract version
        id: version
        run: |
          VERSION=$(cat package.json | jq -r .version)
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Extracted version: $VERSION"

      # dist êµ¬ì¡° ì¬ì •ë ¬
      - name: ğŸ—‚ Prepare versioned build
        run: |
          mkdir -p output/versions/${{ env.APP_VERSION }}
          cp -r dist/* output/versions/${{ env.APP_VERSION }}/

      # loader index.html ìƒì„±
      - name: ğŸ§© Generate loader index.html
        env:
          S3_BUCKET: wexpert-report-dev
        run: |
          # í…œí”Œë¦¿ íŒŒì¼ ë³µì‚¬
          cp templates/loader.html output/index.html

          # S3ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ë²„ì „ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          AVAILABLE_VERSIONS="[]"
          if aws s3 ls s3://$S3_BUCKET/versions/ 2>/dev/null; then
            # S3ì—ì„œ ë²„ì „ ëª©ë¡ ì¶”ì¶œ (1.8.1 í˜•ì‹)
            VERSIONS=$(aws s3 ls s3://$S3_BUCKET/versions/ | grep "PRE" | awk '{print $2}' | sed 's/\///' | sort -V)
            
            # JSON ë°°ì—´ë¡œ ë³€í™˜
            AVAILABLE_VERSIONS="["
            FIRST=true
            for VERSION in $VERSIONS; do
              if [ "$FIRST" = true ]; then
                AVAILABLE_VERSIONS="${AVAILABLE_VERSIONS}\"${VERSION}\""
                FIRST=false
              else
                AVAILABLE_VERSIONS="${AVAILABLE_VERSIONS},\"${VERSION}\""
              fi
            done
            AVAILABLE_VERSIONS="${AVAILABLE_VERSIONS}]"
          fi

          echo "Available versions in S3: $AVAILABLE_VERSIONS"

          # í˜„ì¬ ë°°í¬í•  ë²„ì „ì„ ëª©ë¡ì— ì¶”ê°€ (ì¤‘ë³µ ì²´í¬)
          CURRENT_VERSION="${{ env.APP_VERSION }}"
          if [[ "$AVAILABLE_VERSIONS" != *"\"$CURRENT_VERSION\""* ]]; then
            if [ "$AVAILABLE_VERSIONS" = "[]" ]; then
              AVAILABLE_VERSIONS="[\"$CURRENT_VERSION\"]"
            else
              # ë°°ì—´ ëì— ì¶”ê°€: ["1.8.1"] â†’ ["1.8.1","1.8.2"]
              AVAILABLE_VERSIONS="${AVAILABLE_VERSIONS%]*},\"$CURRENT_VERSION\"]"
            fi
            echo "Added current version: $CURRENT_VERSION"
          fi

          echo "Final available versions: $AVAILABLE_VERSIONS"

          # ë³€ìˆ˜ ì¹˜í™˜ (output/index.htmlì˜ __APP_VERSION__ ë° __AVAILABLE_VERSIONS__ â†’ ì‹¤ì œ ë²„ì „ ë° ë²„ì „ ëª©ë¡ìœ¼ë¡œ ì¹˜í™˜)
          sed -i "s/__APP_VERSION__/${{ env.APP_VERSION }}/g" output/index.html
          sed -i "s/__AVAILABLE_VERSIONS__/$AVAILABLE_VERSIONS/g" output/index.html

      # ë””ë²„ê¹…: output í´ë” êµ¬ì¡° í™•ì¸
      - name: ğŸ” Check output structure
        run: |
          ls -R output/

      # versions/ í´ë” ì „ì²´ ì‚­ì œ (ì¼íšŒì„± ì‘ì—…)
      - name: ğŸ—‘ï¸ Clean all versions
        env:
          S3_BUCKET: wexpert-report-dev
        run: |
          echo "ğŸ—‘ï¸ Deleting all existing versions..."

          if aws s3 ls s3://$S3_BUCKET/versions/ 2>/dev/null; then
            aws s3 rm s3://$S3_BUCKET/versions/ --recursive
            echo "âœ… All versions deleted"
          else
            echo "â„¹ï¸  No versions folder found"
          fi

      - name: ğŸ“¤ Deploy to S3
        env:
          S3_BUCKET: wexpert-report-dev
        run: |
          echo "ğŸ“¤ Uploading new version..."

          # í•„ìš”í•  ë•Œ ì‚¬ìš©
          # ë£¨íŠ¸ ë ˆë²¨ì˜ ì˜¤ë˜ëœ íŒŒì¼ ì •ë¦¬
          # aws s3 rm s3://$S3_BUCKET/assets/ --recursive 2>/dev/null || echo "No assets/ to clean"
          # aws s3 rm s3://$S3_BUCKET/images/ --recursive 2>/dev/null || echo "No images/ to clean"
          # aws s3 rm s3://$S3_BUCKET/service-worker.js 2>/dev/null || echo "No service-worker.js to clean"


          # ìƒˆ êµ¬ì¡° ì—…ë¡œë“œ (ì´ì „ ë²„ì „ ë³´ì¡´)
          aws s3 sync ./output/ s3://$S3_BUCKET/ --exclude ".DS_Store"

          echo "âœ… Deployed to s3://$S3_BUCKET/"
          echo "ğŸ“¦ Version: v${{ env.APP_VERSION }}"

      - name: ğŸ” Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_DEV }} \
            --paths "/*"
