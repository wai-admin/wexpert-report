name: CI

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]

jobs:
  build:
    runs-on: ubuntu-latest
    env: # ëª¨ë“  stepì—ì„œ ê³µìœ ë˜ëŠ” í™˜ê²½ë³€ìˆ˜
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}

    steps:
      - name: ğŸ“· Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦¿ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22.13.1

      - name: ğŸ”§ Install pnpm
        run: npm i -g pnpm

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ§¹ Lint
        run: pnpm lint

      - name: ğŸŒ Build
        run: pnpm build

      # version ì¶”ì¶œ
      - name: ğŸ· Extract version
        id: version
        run: echo "APP_VERSION=$(cat package.json | jq -r .version)" >> $GITHUB_ENV

      # dist êµ¬ì¡° ì¬ì •ë ¬
      - name: ğŸ—‚ Prepare versioned build
        run: |
          mkdir -p output/versions/v${{ env.APP_VERSION }}
          cp -r dist/* output/versions/v${{ env.APP_VERSION }}/

      # loader index.html ìƒì„±
      - name: ğŸ§© Generate loader index.html
        run: |
          cat << 'EOF' > output/index.html
          <!doctype html>
          <html lang="en">
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
              <meta http-equiv="Expires" content="0" />
              <style>
                body {
                  margin: 0;
                  padding: 0;
                  overflow: hidden;
                  background-color: rgba(39, 41, 44, 1);
                  width: 100vw;
                  height: 100vh;
                }
              </style>
            </head>
            <body>
              <script>
                // ë²„ì „ë³„ ê²½ë¡œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ 
                function loadApp(nativeVersion) {
                  // ì›¹ì—ì„œëŠ” targetUrlë¡œ ì´ë™í•˜ì—¬ index.htmlì„ ì°¾ì§€ë§Œ, WebView2ì—ì„œëŠ” index.htmlì„ ì°¾ì§€ ëª»í•˜ë¯€ë¡œ index.htmlì„ ì§ì ‘ ì—´ì–´ì¤€ë‹¤.
                  const targetUrl = '/versions/v' + nativeVersion + '/index.html';
                  window.location.href = targetUrl;
                }

                // C# WebView2 Bridge í†µì‹ 
                function initializeBridge() {
                  if (window.chrome?.webview) {
                    window.chrome.webview.addEventListener('message', function(event) {
                      const data = event.data?.data || event.data;
                      
                      if (data.nativeVersion) {
                        // nativeVersionì—ì„œ ë©”ì´ì €.ë§ˆì´ë„ˆ.íŒ¨ì¹˜ë§Œ ì¶”ì¶œ ("1.8.1.25336" â†’ "1.8.1")
                        const version = data.nativeVersion.split('.').slice(0, 3).join('.');
                        loadApp(version);
                      }
                    });

                    // C#ì— ì´ˆê¸°í™” ë©”ì‹œì§€ ì „ì†¡
                    window.chrome.webview.postMessage({ 
                      type: 'initialized'
                    });
                  } else {
                    // ê°œë°œ í™˜ê²½ fallback
                    loadApp('${{ env.APP_VERSION }}');
                  }
                }

                // DOM ë¡œë“œ í›„ ì‹¤í–‰
                if (document.readyState === 'loading') {
                  document.addEventListener('DOMContentLoaded', initializeBridge);
                } else {
                  initializeBridge();
                }
              </script>
            </body>
          </html>
          EOF

      # ë””ë²„ê¹…: output í´ë” êµ¬ì¡° í™•ì¸
      - name: ğŸ” Check output structure
        run: |
          ls -R output/

      - name: ğŸ“¤ Deploy to S3
        env:
          S3_BUCKET: wexpert-report-dev
        run: |
          echo "ğŸ“¤ Uploading new version..."

          # ë£¨íŠ¸ ë ˆë²¨ì˜ ì˜¤ë˜ëœ íŒŒì¼ ì •ë¦¬
          aws s3 rm s3://$S3_BUCKET/assets/ --recursive 2>/dev/null || echo "No assets/ to clean"
          aws s3 rm s3://$S3_BUCKET/images/ --recursive 2>/dev/null || echo "No images/ to clean"
          aws s3 rm s3://$S3_BUCKET/service-worker.js 2>/dev/null || echo "No service-worker.js to clean"


          # ìƒˆ êµ¬ì¡° ì—…ë¡œë“œ (ì´ì „ ë²„ì „ ë³´ì¡´)
          aws s3 sync ./output/ s3://$S3_BUCKET/ --exclude ".DS_Store"

          echo "âœ… Deployed to s3://$S3_BUCKET/"
          echo "ğŸ“¦ Version: v${{ env.APP_VERSION }}"

      - name: ğŸ” Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_DEV }} \
            --paths "/*"
