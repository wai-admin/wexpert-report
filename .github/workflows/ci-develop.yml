name: CI

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]

jobs:
  build:
    runs-on: ubuntu-latest
    env: # ëª¨ë“  stepì—ì„œ ê³µìœ ë˜ëŠ” í™˜ê²½ë³€ìˆ˜
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}

    steps:
      - name: ğŸ“· Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦¿ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22.13.1

      - name: ğŸ”§ Install pnpm
        run: npm i -g pnpm

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ§¹ Lint
        run: pnpm lint

      - name: ğŸŒ Build
        run: pnpm build

      # version ì¶”ì¶œ
      - name: ğŸ· Extract version
        id: version
        run: echo "APP_VERSION=$(cat package.json | jq -r .version)" >> $GITHUB_ENV

      # dist êµ¬ì¡° ì¬ì •ë ¬
      - name: ğŸ—‚ Prepare versioned build
        run: |
          mkdir -p output/versions/v${{ env.APP_VERSION }}
          cp -r dist/* output/versions/v${{ env.APP_VERSION }}/

      # loader index.html ìƒì„±
      - name: ğŸ§© Generate loader index.html
        run: |
          # í…œí”Œë¦¿ íŒŒì¼ ë³µì‚¬
          cp templates/loader.html output/index.html

          # ë³€ìˆ˜ ì¹˜í™˜ (output/index.htmlì˜ __APP_VERSION__ â†’ ì‹¤ì œ ë²„ì „ìœ¼ë¡œ ì¹˜í™˜)
          sed -i "s/__APP_VERSION__/${{ env.APP_VERSION }}/g" output/index.html

      # ë””ë²„ê¹…: output í´ë” êµ¬ì¡° í™•ì¸
      - name: ğŸ” Check output structure
        run: |
          ls -R output/

      - name: ğŸ“¤ Deploy to S3
        env:
          S3_BUCKET: wexpert-report-dev
        run: |
          echo "ğŸ“¤ Uploading new version..."

          # ë£¨íŠ¸ ë ˆë²¨ì˜ ì˜¤ë˜ëœ íŒŒì¼ ì •ë¦¬
          aws s3 rm s3://$S3_BUCKET/assets/ --recursive 2>/dev/null || echo "No assets/ to clean"
          aws s3 rm s3://$S3_BUCKET/images/ --recursive 2>/dev/null || echo "No images/ to clean"
          aws s3 rm s3://$S3_BUCKET/service-worker.js 2>/dev/null || echo "No service-worker.js to clean"


          # ìƒˆ êµ¬ì¡° ì—…ë¡œë“œ (ì´ì „ ë²„ì „ ë³´ì¡´)
          aws s3 sync ./output/ s3://$S3_BUCKET/ --exclude ".DS_Store"

          echo "âœ… Deployed to s3://$S3_BUCKET/"
          echo "ğŸ“¦ Version: v${{ env.APP_VERSION }}"

      - name: ğŸ” Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_DEV }} \
            --paths "/*"
